Import('env')

libs=['giv-widget','gtkimageviewer_local','aggx','plis','pcrex']
for p in [#'pgm.c',
          'npy.c',
#          'simple_dicom.c'
          ]:
    env.SharedLibrary(p,
                      LIBPATH=['..','../gtkimageviewer','../agg','../pcre','../plis']+env['LIBPATH'],
                      LIBS = ['giv-image']+env['LIBS']
                      )

# Change this to Maemo
if not env['SBOX']:
    cpppath_fits = ['./cfitsio']
    libpath_fits = ['./cfitsio']
    libs_fits = ['cfitsio']

    # Prefer system fits library if it exists
    conf = Configure(env)
    if conf.CheckLib('libcfitsio'):
        print "Using system cfitsio library"
        cpppath_fits = []
        libpath_fits = []
        libs_fits = []
        env.ParseConfig('pkg-config --cflags --libs cfitsio')

    env.SharedLibrary('fits',
                      ['fits.c'],
                      LIBPATH=libpath_fits + ['..','../gtkimageviewer','../agg','../pcre','../plis']+env['LIBPATH'],
                      LIBS=libs_fits + ['giv-image']+env['LIBS'],
                      CPPPATH= cpppath_fits + env['CPPPATH']
                      )
    
    plugin_dicom = env.SharedLibrary('dicom',
                      ['dicom.cc'],
                      CPPPATH=['dcmtk/dcmdata/include',
                               'dcmtk/ofstd/include',
                               'dcmtk/config/include',
                               '..'
                               ] + env['CPPPATH'],
                      LIBPATH=['..','#/src/plugins/dcmtk/${ARCHDIR}/${VARIANT}'] + env['LIBPATH']+env['LIBPATH'],
                      LIBS=['dcmdata','ofstd','giv-image']+env['LIBS'])
    env.SharedLibrary('tiff',
                      ['tiff.c'],
                      LIBPATH=['..','../gtkimageviewer','../agg','../pcre','../plis'] + env['LIBPATH'],
                      LIBS=['libtiff','giv-image']+env['LIBS'],
                      )
    env.Depends(plugin_dicom,
                ['#/src/plugins/dcmtk/${ARCHDIR}/${VARIANT}/libdcmdata.a',
                 '#/src/plugins/dcmtk/${ARCHDIR}/${VARIANT}/libofstd.a'])

    if ARGUMENTS.get('mingw', 0):
        png_lib = ['png15']
    else:
        png_lib = []
#    env.SharedLibrary('png',
#                      ['png.c'],
#                      LIBPATH=['..','../gtkimageviewer','../agg','../pcre','../plis'] + env['LIBPATH'],
#                      LIBS=['giv-image']+png_lib+env['LIBS'],
#                      )
    
#    if env['ARCHDIR'] != 'linux':
#        SConscript(['cfitsio/SConscript'],
#                   exports = 'env')

    SConscript(['dcmtk/SConscript'],
               exports='env')
